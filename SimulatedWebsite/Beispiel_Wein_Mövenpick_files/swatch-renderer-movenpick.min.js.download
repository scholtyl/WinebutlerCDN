define(['jquery','underscore','mage/template','priceUtils','text!Magento_Catalog/template/badges/tier-price.html','text!Magento_Catalog/template/badges/open-tag.html','text!Magento_Catalog/template/badges/badge-text.html'],function($,_,mageTemplate,priceUtils,tierPriceBadgeTemplate,openTagBadgeTemplate,badgeTextTemplate){'use strict';return function(swatchRenderer){$.widget('mage.SwatchRenderer',swatchRenderer,{qtyInputElement:null,$essentialsSectionElement:$('.cs-buybox__section--essentials'),badgesConfig:{$badgesContainerElement:$('.cs-page-product__badges'),discountBadgeSelector:'.cs-page-product__badge-item--discount',tierPriceSaleBadgeSelector:'.cs-page-product__badge-item--tier-price',tierPriceOpenTagBadgeId:'#tier_price_open_tag_badge',tierPriceTextBadgeId:'#tier_price_text_badge',ALLOWED_TIER_PRICE_QTY:6,},_init:function(){this._super();this.bottleSizeLabelElement=$('.cs-buybox__price-notes-size-value');this.unitPriceElement=$('.cs-buybox__price-notes-unit-price-value');this._initiallySelectFirstSwatchOption();this._showNonFirstSwatches();},_OnClick:function($this,$widget){this._super($this,$widget);const selected=this._getSelectedSwatchesOptions();if(!Object.keys(selected).length){return;}
const productId=this.getProduct();this._updateBottleSizeLabel(selected);this._updateSkuAfterSwatchSelection(productId);this._updateUnitPrice(productId);this._updateQtyDefaultValue(productId);this._updateQtyIncrementStep(productId);this._showNonFirstSwatches();},_UpdatePrice:function(){this._super();this._updateTierPriceBadges();},_updateBottleSizeLabel:function(selected){Object.keys(selected).forEach((key)=>{const attributeId=key;const optionId=selected[key];const $attributeElement=$(`[data-attribute-id="${attributeId}"]`);if(!$attributeElement.length||!$attributeElement.hasClass('mpw_bottle_size')){return;}
const $optionElement=$attributeElement.find(`[data-option-id="${optionId}"]`);if($optionElement.length&&$optionElement.hasClass('selected')){const updatedValue=$optionElement.data('option-tooltip-value');if(this.bottleSizeLabelElement&&updatedValue){this.bottleSizeLabelElement.text(updatedValue);}}});},_updateSkuAfterSwatchSelection:function(productId){if(productId&&this.options.jsonConfig.sku[productId]){const newSku=this.options.jsonConfig.sku[productId];const $skuElement=$('[data-id="sku"]');if($skuElement.length){$skuElement.text(newSku);}}},_updateUnitPrice:function(productId){if(productId&&this.options.jsonConfig.unitPrice){if(!this.options.jsonConfig.unitPrice[productId]){return;}
const newUnitPrice=this.options.jsonConfig.unitPrice[productId];if(this.unitPriceElement&&newUnitPrice){this.unitPriceElement.text(newUnitPrice);}}},_updateTierPriceBadges:function(){const result=this._getNewPrices();const $discountBadge=$(this.badgesConfig.discountBadgeSelector);const $tierPriceSaleBadge=$(this.badgesConfig.tierPriceSaleBadgeSelector);const $tierPriceOpenTagBadge=$(this.badgesConfig.tierPriceOpenTagBadgeId);const $tierPriceTextBadge=$(this.badgesConfig.tierPriceTextBadgeId);if(typeof result!=='undefined'&&result.tierPrices&&result.tierPrices.length&&result.tierPrices[0].qty===this.badgesConfig.ALLOWED_TIER_PRICE_QTY){if(!$discountBadge.length||!$discountBadge.is(':visible')){this._renderBadge({$existingBadge:$tierPriceSaleBadge,template:tierPriceBadgeTemplate,container:this.badgesConfig.$badgesContainerElement,data:{value:result.tierPrices[0].percentage,qty:$.mage.__('for %1 btl.').replace('%1',this.badgesConfig.ALLOWED_TIER_PRICE_QTY),},});}
let priceDiff=(result.finalPrice.amount-result.tierPrices[0].price)*this.badgesConfig.ALLOWED_TIER_PRICE_QTY;this._renderBadge({$existingBadge:$tierPriceOpenTagBadge,template:openTagBadgeTemplate,container:this.$essentialsSectionElement,insertAfter:true,data:{value:$.mage.__('Buy %1 for %2 each and save %3').replace('%1',this.badgesConfig.ALLOWED_TIER_PRICE_QTY).replace('%2',this.formatPrice(result.tierPrices[0].price)).replace('%3',this.formatPrice(priceDiff))},});this._renderBadge({$existingBadge:$tierPriceTextBadge,template:badgeTextTemplate,container:this.$essentialsSectionElement,insertAfter:true,data:{value:$.mage.__('Cardboard offer %1').replace('%1',result.tierPrices[0].percentage)},});}else{this._hideBadges([$tierPriceSaleBadge,$tierPriceOpenTagBadge,$tierPriceTextBadge]);}},_renderBadge:function({$existingBadge,template,container,insertAfter=false,data}){const badgeHtml=mageTemplate(template,data);if(!$existingBadge.length){if(insertAfter){container.after(badgeHtml);}else{container.append(badgeHtml);}}else{$existingBadge.replaceWith(badgeHtml);}},_hideBadges:function(badges){badges.forEach(($badge)=>{if($badge.length){$badge.hide();}});},formatPrice:function(price){return priceUtils.formatPrice(price,this.options.jsonConfig.priceFormat);},_getSelectedSwatchesOptions:function(){const selectedOptions={};$('div.swatch-attribute').each((index,element)=>{const $element=$(element);const attributeId=$element.data('attribute-id');const selectedOption=$element.find('.swatch-option.selected').data('option-id');if(attributeId&&selectedOption){selectedOptions[attributeId]=selectedOption;}});return selectedOptions;},_initiallySelectFirstSwatchOption:function(){const optionsToSelect={};Object.values(this.options?.jsonConfig?.attributes||{}).forEach((attribute)=>{const{options,id}=attribute;const salableOptions=(options||[]).filter((option)=>this.options.jsonConfig.salable?.[id]?.[option.id]);if(salableOptions.length===1){const option=salableOptions[0];if(option.products?.length){optionsToSelect[attribute.code]=option.id;}}});this._EmulateSelected(optionsToSelect);},_showNonFirstSwatches:function(){const $swatches=this.element.find('.swatch-attribute');if(!$swatches.first().data('option-selected'))return;$swatches.slice(1).css('visibility','visible');$swatches.find('.swatch-option').css('visibility','visible');},_updateQtyDefaultValue:function(productId){if(!productId||!this.options.jsonConfig.qtyDefault){return;}
const qtyDefault=this.options.jsonConfig.qtyDefault[productId];if(!qtyDefault){return;}
const qtyInputElement=this.getQtyInputElement();if(!qtyInputElement.length){return;}
qtyInputElement.val(qtyDefault);},_updateQtyIncrementStep:function(productId){if(!productId||!this.options.jsonConfig.qtySteps){return;}
const qtyStep=this.options.jsonConfig.qtySteps[productId];if(!qtyStep){return;}
const qtyInputElement=this.getQtyInputElement();if(!qtyInputElement.length){return;}
qtyInputElement.attr('step',qtyStep).attr('min',qtyStep).trigger('update');if(typeof qtyInputElement.rules==='function'){try{const currentRules=qtyInputElement.rules();qtyInputElement.rules('add',{'validate-item-quantity':{...currentRules['validate-item-quantity'],qtyIncrements:qtyStep}});}catch(e){}}},getQtyInputElement:function(){if(!this.qtyInputElement){this.qtyInputElement=this.element.parents('form').find('input[name="qty"]');}
return this.qtyInputElement;}});return $.mage.SwatchRenderer;};});