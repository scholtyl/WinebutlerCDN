define(['jquery','underscore','Magento_Customer/js/customer-data','jquery/jquery-storageapi'],function($,_,customerData){'use strict';var exports=window;var defaultSiteId;var defaultTrackerUrl;var origMatomoAsyncInit=exports.matomoAsyncInit;var matomo=exports.Matomo||null;var matomoPromises=[];var storage=$.initNamespaceStorage('chessio-matomo').localStorage;var cartObservable=customerData.get('cart');var customerObservable=customerData.get('customer');function injectScript(scriptUrl){$('<script>').attr('type','text/javascript').attr('async',true).attr('defer',true).attr('src',scriptUrl).appendTo('head');}
function resolveMatomoPromises(){if(matomo){_.each(matomoPromises,function(deferred){deferred.resolve(matomo);});}else{_.each(matomoPromises,function(deferred){deferred.reject();});}}
function onMatomoLoaded(){if(_.isFunction(origMatomoAsyncInit)){origMatomoAsyncInit();}
matomo=_.isObject(exports.Matomo)?exports.Matomo:false;if(defaultSiteId&&defaultTrackerUrl){resolveMatomoPromises();}}
function getMatomoPromise(){var deferred=$.Deferred();if(matomo===null||!defaultSiteId||!defaultTrackerUrl){matomoPromises.push(deferred);}else if(matomo===false){deferred.reject();}else{deferred.resolve(matomo);}
return deferred.promise();}
function getAsyncTrackerPromise(){var deferred=$.Deferred();getMatomoPromise().done(function(matomoObject){deferred.resolve(matomoObject.getAsyncTracker());}).fail(function(){deferred.reject();});return deferred.promise();}
function getTrackerPromise(trackerUrl,siteId){var deferred=$.Deferred();getMatomoPromise().done(function(matomoObject){deferred.resolve(matomoObject.getTracker(trackerUrl||defaultTrackerUrl,siteId||defaultSiteId));}).fail(function(){deferred.reject();});return deferred.promise();}
function pushAction(action,tracker){var event,actionName;if(!_.isArray(action)||_.isEmpty(action)){return;}else if(_.isArray(_.first(action))){_.each(action,function(subAction){pushAction(subAction,tracker);});return;}
if(/^track/.test(_.first(action))){event=$.Event('matomo:beforeTrack');$(exports).triggerHandler(event,[action,tracker]);if(event.isDefaultPrevented()){return;}else if(_.isArray(event.result)){action=event.result;}}
if(_.isObject(tracker)){actionName=action.shift();if(_.isFunction(tracker[actionName])){tracker[actionName].apply(tracker,action);}}else{exports._paq.push(action);}}
function cartUpdated(cart){if(_.has(cart,'data_id')){if(storage.get('cart-data-id')===cart.data_id){return;}
storage.set('cart-data-id',cart.data_id);}
if(_.has(cart,'matomoActions')){getTrackerPromise().done(function(tracker){pushAction(cart.matomoActions,tracker);});}}
function customerUpdated(customer){if(_.has(customer,'matomoUserId')){storage.set('user-id',customer.matomoUserId);}else{storage.remove('user-id');}}
function addVisitorDataBeforeTrack(event,action,tracker){if(storage.isSet('user-id')){pushAction(['setUserId',storage.get('user-id')],tracker);}}
function scriptExists(scriptUrl){return $('script[src="'+scriptUrl+'"]').length===1;}
function initialize(options){defaultSiteId=options.siteId;defaultTrackerUrl=options.trackerUrl;if(matomo===null){if(!scriptExists(options.scriptUrl)){pushAction([['setSiteId',defaultSiteId],['setTrackerUrl',defaultTrackerUrl]]);injectScript(options.scriptUrl);}}else{resolveMatomoPromises();}
pushAction(options.actions);}
exports._paq=exports._paq||[];exports.matomoAsyncInit=onMatomoLoaded;cartObservable.subscribe(cartUpdated);customerObservable.subscribe(customerUpdated);$(exports).on('matomo:beforeTrack',addVisitorDataBeforeTrack);return{createTracker:getTrackerPromise,getMatomo:getMatomoPromise,getTracker:getAsyncTrackerPromise,push:pushAction,'Chessio_Matomo/js/tracker':initialize};});